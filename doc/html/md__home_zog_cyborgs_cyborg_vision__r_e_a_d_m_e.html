<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FRC #4221 Joliet Cyborgs Computer Targetting and Ranging: Vision-related code for FRC #4241 vision efforts</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">FRC #4221 Joliet Cyborgs Computer Targetting and Ranging
   &#160;<span id="projectnumber">1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Vision-related code for FRC #4241 vision efforts </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Overview</h2>
<p>Architecture is a server (cv_cam) for each camera that watches the serial camera output and sends it via a UDP packet to the processor (cv_proc). Each cv_cam modules passes robot object and visual field location information to cv_proc.</p>
<p>The processor maintains lists per camera, per identified object with timestamps and coordinate-based values for each record. A time-based sequence of camera records is maintained for each object the cameras report. A separate thread prunes the lists based on an overall Time-To-Live (TTL) value to remove old records but still allow access to the latest information from each camera as well as an averaged set of values based on the TTL.</p>
<p>Another thread processes the records per identified object (on request) and creates direction commands and calculates distances to the identified object./ This thread will communicate with the cv_robo module.</p>
<p>A third component (cv_robo) will communicate with cv_proc and work with the robot code to steer, drive, and otherwise operate the robot based on visual cues. Cv_robo will act just like a human-operated joystick and move the robot and actuate the appropriate functions based on visual cues (just like a human operator would). The actual robot driving logic lives here.</p>
<p>The overall system is designed to operate around a pair of JeVois smart cameras using both the CLI API to control and configure the cameras and the serial output providing object-based information. Overall, the system is fairly independent of the visual processing strategy used.</p>
<h2>Architecture</h2>
<h2>Connectivity</h2>
<h2>Key programming concepts to know to understand the code</h2>
<p>For maximum portability and control, the bulk of the software is written in C. There are several concepts that are important to know in order to understand and modify the code.</p>
<p>These include:</p>
<h3>#define</h3>
<p>Understanding the #define directive is an important part in creating readable and maintainable code. This is really part of a while family of directives including things like #ifdef, #ifndef, #else, #endif, and others. Good use of these directives gives you the ability to change your code with a compile-time directive (like enabling specific deep debugging output or accommodating platforms differences through platform-specific code for example).</p>
<p>They also provide an effective way to define various constants used in your code in a good human-readable way so you'll very often see them used in that capacity. For example, the cv_proc module is intended to support two (2) cameras and the code takes that into account. It's obvious that there are some parts of the code that need to be aware of that fact. You could just use the hard-coded value "2" in these places sort of like this:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> placeToPutStuff[2];</div></div><!-- fragment --><p>In this case, it's hard to know why there this array has 2 elements. Consider this as an alternative:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define NUM_OF_CAMERAS</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> placeToPutStuff[<a class="code" href="cv__cam_8h.html#a92383bd69cf2d06a13f8e2fe1d327069">NUM_OF_CAMERAS</a>];</div></div><!-- fragment --><p>Without even seeing more than that, it's obvious that this is related to number of cameras defined. Imagine wanting to change the code from supporting 2 cameras to 3 cameras; it's easy to update the NUM_OF_CAMERAS #define and change it from 2 to 3 and have a lot of data structures be updated accordingly. Otherwise you're left trying to figure out what that "2" means; is it the number of cameras or just something else in the code that there happen to be two of?</p>
<p>In addition, you'll also see them used as a macro for some code that you don't want to put in a separate function but want to be expanded in-line right in the code without repeating it over and over. With a #define, you can "define" it once and easily incorporate it where needed - the Camera List data structure lock and unlocking code is a good example of this in the cv_proc code.</p>
<p>Some links:</p>
<ul>
<li><a href="https://www.geeksforgeeks.org/cc-preprocessors/">C/C++ Preprocessors</a></li>
<li><a href="https://docs.microsoft.com/en-us/previous-versions/teas0593(v=vs.140)">#define Directive (C/C++)</a></li>
</ul>
<p>As a point of information, the term "preprocessor" refers to the compiler pass that first handles all of the #defines and other #something directives before the code is compiled. Historically this was done by a separate program called the, wait for it, the "preprocessor" though this behavior is built-into many modern compilers (but usually there is an option to see the "pre-processed" code where you can see the code with all of the preprocessor changes which is very handy for debugging more complicated macro definitions.</p>
<h3>Structures and Typedefs</h3>
<p>Structures are a key way in C and C++ to group related variables together. The combine multiple variables into a data entity that can be stored, passed around in the code, and manipulated in a way that maintains the relationships between the variables there in.</p>
<p>For example, a structure in the vision code could look like this:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>iSeeYou {</div><div class="line">    <span class="keywordtype">char</span> thingISee[100];   /  name of the thing I see</div><div class="line">    <span class="keywordtype">int</span>  x;                <span class="comment">// x coordinate in the camera&#39;s view</span></div><div class="line">    <span class="keywordtype">int</span>  y;                <span class="comment">// y coordinate in the camera&#39;s view</span></div><div class="line">}</div></div><!-- fragment --><p>This creates a new data type which can be referenced just like a more basic data type - for example, we could declare an array those structures like this:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>iSeeYou thingsSeen[20];</div></div><!-- fragment --><p>There is a specific syntax to deal with these items - below is an example where we set the X coordinate of the 5th item to 12345:</p>
<div class="fragment"><div class="line">thingsSeen[4].x = 12345;    <span class="comment">// remember, arrays start at 0!</span></div></div><!-- fragment --><p>Typedefs are a lot like structure definitions but they allow us to actually define a new data type - let's use the above example and create a new data type STUFF_SEEN:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    <span class="keywordtype">char</span> thingISee[100];   /  name of the thing I see</div><div class="line">    <span class="keywordtype">int</span>  x;                <span class="comment">// x coordinate in the camera&#39;s view</span></div><div class="line">    <span class="keywordtype">int</span>  y;                <span class="comment">// y coordinate in the camera&#39;s view</span></div><div class="line">} STUFF_SEEN;</div></div><!-- fragment --><p>This looks a lot like the original structure but we can use it much easier in the code - for example, here's a declaration of a variable of this new type:</p>
<div class="fragment"><div class="line">STUFF_SEEN  hey;</div></div><!-- fragment --><p>More details at:</p>
<ul>
<li><a href="https://www.geeksforgeeks.org/structures-c/">Structures in C</a></li>
<li><a href="https://en.wikipedia.org/wiki/Struct_(C_programming_language)">Struct (C programming Language)</a>)</li>
<li><a href="https://www.tutorialspoint.com/cprogramming/c_structures.htm">C - Structures</a></li>
</ul>
<h3>Pointers</h3>
<p>Pointers are a way to efficiently access memory locations corresponding to variables and structures when using C. Pointers allow efficient access by "pointing" to code to locations of variables and structures rather than passing entire structures around. The use of pointers also supports more sophisticated and flexible data structures such as linked lists which in some usages are much more flexible and powerful than arrays (as one example). Understanding the use of pointers and the processing associated with pointer arithmetic is a requirement for almost any non-trivial C programming effort.</p>
<p>Many system and library calls use pointers to pass or return structures so it is very important to have this understanding to make best use of the system call and utility library functions.</p>
<p>Here links to some information sources that can help explain pointers:</p>
<ul>
<li><a href="http://www.circuitstoday.com/introduction-to-pointers-in-c">Introduction to pointers in C</a></li>
<li><a href="https://www.go4expert.com/articles/introduction-pointers-c-t27959/">Introduction to pointers in Ci (seems to be a popular title for this topic)</a></li>
<li><a href="https://www.youtube.com/watch?v=h-HBipu_1P0">Introduction to pointers in C/C++ (video)</a></li>
</ul>
<h3>Linked Lists</h3>
<p>Linked Lists are a key basic data structure. Pointers are the easiest (not the only but by far the easiest) way to implement linked lists. Linked lists provide a flexible mean to connect data records in a way where they can be added, deleted, or reordered without moving large amounts of data by simply changing a few pointers.</p>
<p>Here are a few resources to get you up to speed on linked lists:</p>
<ul>
<li><a href="https://www.zentut.com/c-tutorial/c-linked-list/">C Linked List</a></li>
<li><a href="https://www.codeproject.com/articles/641175/%2fArticles%2f641175%2fAn-Introduction-to-Linked-Lists-in-C-Cplusplus">Introduction to Linked Lists in C/C++</a></li>
<li><a href="https://www.geeksforgeeks.org/linked-list-set-1-introduction/">Linked List Introduction</a></li>
</ul>
<h3>System and Library Calls</h3>
<p>These are the basic calls to get the operating system to do something for us - open a file, get us some more memory, kill something that's running, etc. System calls are the most basic functionality the operating system (Linux, Windows, etc). can provide - you get the most control but at times they can be harder to use. There are environments that have a very minimal (or maybe even no operating system) like an Arduino, a set of pretty basic routines (like the RoboRio) or a full tilt, crankin' it out operating system like Linux (a Raspberry Pi is a good example of that).</p>
<p>Library calls will look very similar and often times cause the operating system to do something as well. Things that fall into that category are routines like stdio (C) or iostream (C++); these sorts of routines provide an easier to use or more flexible and hide some of the system call complexity (stdio and iostream are perfect examples of that). They'll also provide functionality that many programs want to use like string manipulation that while they aren't things the operating system cares about ("I'm an 'OPERATING SYSTEM' friend - I don't do string comparison!").</p>
<p>There are a lot of function calls that fall into these areas - 100's at least (at one point I knew pretty much all of them but a lot of water has flowed under the bridge and a lot of routines have been added so that's probably not the case anymore). So how do you get started? I'd start by looking at the code and using one of the good "manpage" sites online ("manpage" is short for manual page so you won't sound like you're not hip to the groove that's being laid down).</p>
<p>A good site for Linux manpages is <a href="http://man7.org/linux/man-pages/dir_all_alphabetic.html">Man7.org</a>.</p>
<p>Manpages will have standard set of sections that will you understand what's happening - for system and library calls, you'll typically see:</p>
<ul>
<li><b>Name</b></li>
<li><b>Synopsis</b> (function name, parameters, and return types - if you know what you are doing, a lot of times this is all you need to jar your memory)</li>
<li><b>Description</b> (the will provide more information on what it does and what the parameters or options are if it's not totally obvious)</li>
<li><b>Return Value</b> (what you get back if it works as well as if it doesn't work)</li>
<li><b>See Also</b> (cross references to other related functions - the page to "open" something probably has a link to the functions to "close" it or otherwise manipulate it so if you just remember one name, you can get connected to the other complimentary functions just about every time)</li>
</ul>
<p>You'll notice there are numbers involved (we never said there would be no math!); these numbers mean things. The numbers 2 and 3 are probably the most interesting to software developers as those identify system calls and library functions respectively - these are functions your program can actually call. Things with number 1 are commands - things you'd type at the Linux command prompt to do something other than calling a function in your program.</p>
<p>Here are a few examples:</p>
<ul>
<li><a href="http://man7.org/linux/man-pages/man3/string.3.html">string(3)</a> - various C string functions (there are quite a few)</li>
<li><a href="http://man7.org/linux/man-pages/man1/cp.1.html">cp(1)</a> - command to copy files and directories; lots of options in the "Description" section</li>
</ul>
<h3>Memory Management</h3>
<p>Many programming languages relieve the programmer from having to manage memory - that is the need to get memory to put new data and objects into and the need to dispose of it when it's no longer needed (not disposing of unneeded memory is generally considered a bug; at best your application will just keep growing but at worst, you'll overwrite or discard the pointer needed to free memory and create what is considered a "memory leak" - these are not considered a feature). The languages that do this automatically are typically referred to as supporting <em>automatic garbage collection</em>; Java is one of those, C isn't.</p>
<p>In C, you allocate memory using the <a href="https://linux.die.net/man/3/malloc">malloc</a>() function to get more memory (think of it as shorthand for **m**emory **alloc**ation). This function will make a certain amount of memory available to the program for use. This memory can be used to store anything, any type of data, for as long as you need to store or (or at least until your program exits at which point any memory used by it it released so it's not lost <em>forever</em> ;). Malloc() returns a pointer if successful; otherwise it returns 0 (or a NULL pointer in the parlance of C). This is something your program wants to check for just to make sure something awful hasn't happened. The vision processing system has it's malloc() call in <a class="el" href="utility_8c.html">utility.c</a> and is wrapped by a function called <a class="el" href="utility_8c.html#a1716a2f1dbfb9632f89d75a83b017ed7" title="cyborg vision malloc front end ">cvAlloc()</a>. If a memory allocation ever fails, it's likely that the situation not just for your program, but potentially for the whole system is, well, grim. There isn't a lot you would typically do except for exit if that happens (if you really know what you're doing and think you're program can continue, you might want to include logic to try and continue but keep in mind that some other code might want to allocate memory including some library calls which might be much less tolerate of a malloc() failure).</p>
<p>Complimentary function to malloc is <a href="https://linux.die.net/man/3/malloc">free</a>() which takes a pointer returned by malloc() and takes that memory "back" for re-use by the program potentially as the return from a future malloc() call.</p>
<p><em>Important note</em>: Malloc() returns a pointer - when you all free(), you want to pass that <em>exact</em> pointer value back.</p>
<p>Behind the scenes, there is a memory management routine running that allocates memory for your program in bigger chunks. This is typically referred to as the <em>heap</em>. The malloc() routine keeps a list of memory addresses it handed out and how big of an area that pointer was associated with. If you look at the documentation for the calls to malloc(), you'll see it's pretty much an all or nothing interface as you either get a pointer back meaning you got what you asked for or you get back nothing. Likewise, when you call free() with a pointer value you got from a malloc() call, you're also not passing the size of the amount of memory you're freeing, just a pointer to it. The free routines looks into a list of pointers that were already handed out, which include how much memory that pointer was pointing to, and marks it internally as being available. If you pass a different value, you really gum up the works. In the pro world, we refer to that as <em>heap corruption</em> and done enough times (or honestly just once), it messes up the lists this library call uses to track, manage, and return memory to the point where it could lose track of some memory (creating a dreaded <em>leak</em>) or even worse, it could give out some memory <em>twice</em> causing some very, very, very hard to find find data corruption bugs (imagine you had two variables, <b>x</b> and <b>y</b> and somehow they ended up overlapping the memory used to store what you thought were two very simple, completely distinct variables and when you updated one, you subtly altered the value of the other in a program section far, far away. That will be <em>very</em> tough to find.</p>
<p>So the pro tip of the day: make sure you give back what you got, and only what you got, and only once (because free()ing something more than once will also lead to *heap corruption).</p>
<p>Some resources for learning more about C memory management:</p>
<ul>
<li><a href="https://www.tutorialspoint.com/cprogramming/c_memory_management.htm">C - Memory Management</a></li>
<li><a href="https://www.tutorialcup.com/cprogramming/memory-management.htm">Memory Management in C Programming</a></li>
<li><a href="https://stackoverflow.com/questions/24891/c-memory-management">C Memory Management</a></li>
</ul>
<p>This might all seem like a giant pain but it really isn't; you actually learn to better appreciate how memory is actually managed and used so even in environments with garbage collection, you'll create less garbage (the big downside of automatic garbage collection is that when the environment needs to do it, you're program essentially freezes - not good for situation where you are controlling something in real time; like say, a robot. Stop processing events on or around your robot at seemingly random times for random amounts of time? Hello Mr. Wall or have a nice broken part because you sent a command to move something and weren't able to read the limit switch to stop from breaking something on your robot. Not good.</p>
<h3>Sockets and Networking</h3>
<h3>Multi-threaded Programming</h3>
<h3>Recursion</h3>
<ul>
<li>[C - Recursion]9https://www.tutorialspoint.com/cprogramming/c_recursion.htm)</li>
</ul>
<h3>Locks and Mutexes</h3>
<p>First off, you need to know how to pronounce "mutex" (syllable break between the "u" and the "t") - check out how "Julia" pronounces it at <a href="https://www.definitions.net/pronounce/mutex">Definitions.net</a> - listen <em>ONLY</em> to Julia, everyone else is pronouncing it, well, <em>WRONG</em> (OK, "Oliver" and "Emily" are pretty solid too but skip the US English dudes for sure as they clearly are not programmers).</p>
<p>Mu-tex - OK, now we can move on.</p>
<h2>Conclusion</h2>
<p>There is a lot going on in this design and corresponding code. Depending on your level of experience with C and the Linux environment, this might be the most complicated code you've dealt with to date. Don't hesitate to search for and read about some of the topics to learn more; also don't hesitate to ask me to help explain something as I'll be glad to do so.</p>
<ul>
<li>Chris Herzog </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
